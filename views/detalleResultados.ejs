<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Resultados de Solicitud</title>
    <link rel="stylesheet" href="/detalleSolicitudAdmin.css" />
    <style>
      .estado-logrado {
        background-color: #e8f5e9;
        border-left: 5px solid #4caf50;
      }
      .estado-no-logrado {
        background-color: #ffebee;
        border-left: 5px solid #f44336;
      }
      .estado-evaluacion {
        background-color: #f0f0f0;
        border-left: 5px solid #9c27b0;
      }
      .estado-en-proceso {
        background-color: #fff8e1;
        border-left: 5px solid #ffca28;
      }
      .estado-logrado,
      .estado-no-logrado,
      .estado-evaluacion,
      .estado-en-proceso {
        padding: 10px;
        margin-top: 10px;
        border-radius: 4px;
      }
      .acreditacion-box {
        padding: 15px;
        border: 2px solid #333;
        margin: 20px 0;
        border-radius: 8px;
        background-color: #f7f7f7;
        text-align: center;
      }
      .btn-certificado {
        background-color: #4caf50;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 10px;
      }
      .btn-certificado:hover {
        background-color: #388e3c;
      }
    </style>
  </head>
  <body>
    <header>
      <a class="back-btn" href="/user/home">‚Üê Atr√°s</a>
      <h1>Resultados de la Solicitud</h1>
      <div class="info-solicitud">
        <p><strong>Universidad:</strong> <%= solicitud.nombre_universidad %></p>
        <p><strong>Carrera:</strong> <%= solicitud.nombre_carrera %></p>
        <p>
          <strong>Fecha de Creaci√≥n:</strong>
          <%= new Date(solicitud.fecha_creacion).toLocaleDateString('es-PE', {
            day: '2-digit', month: '2-digit', year: 'numeric'
          }) %>
        </p>
      </div>
    </header>

    <main class="container">
      <% let tieneNoLogrado = false, tieneEnProceso = false, todosLogrados = true; %>
      <% evaluaciones.forEach(ev => {
        if (ev.estado === 'No logrado') tieneNoLogrado = true;
        if (ev.estado === 'En proceso') tieneEnProceso = true;
        if (ev.estado !== 'Logrado') todosLogrados = false;
      }); %>

      <div class="acreditacion-box">
        <% if (tieneNoLogrado) { %>
          <h2 style="color:#f44336;">‚ùå La carrera NO ACREDITA</h2>
        <% } else if (todosLogrados) { %>
          <h2 style="color:#4caf50;">‚úÖ La carrera ACREDITA por 6 a√±os</h2>
          <form method="GET" action="/user/certificado/<%= solicitud.id_solicitud %>">
            <button class="btn-certificado">üìÑ Descargar Certificado</button>
          </form>
        <% } else if (tieneEnProceso && !tieneNoLogrado) { %>
          <h2 style="color:#ffca28;">üü° La carrera ACREDITA por 2 a√±os</h2>
          <form method="GET" action="/user/certificado/<%= solicitud.id_solicitud %>">
            <button class="btn-certificado">üìÑ Descargar Certificado</button>
          </form>
        <% } %>
      </div>

      <% secciones.forEach(seccion => { %>
        <div class="seccion">
          <h2><%= seccion.nombre.replace(/\b\w/g, c => c.toUpperCase()) %></h2>

          <% const archivosSeccion = archivosPorSeccion.find(a =>
              a.seccion.id_seccion === seccion.id_seccion); %> 

          <% if (archivosSeccion && archivosSeccion.archivos.length > 0) { %>
            <ul class="lista-archivos">
              <% archivosSeccion.archivos.forEach(archivo => { %>
              <li>
                <span><%= archivo.nombre_archivo %> (<%= archivo.tipo_mime %>)</span>
                <a
                  href="/user/descargar-archivo/<%= archivo.id_archivo %>"
                  class="btn-descargar"
                  download
                  >Descargar</a>
              </li>
              <% }) %>
            </ul>
          <% } else { %>
            <p class="sin-archivos">No hay archivos subidos en esta secci√≥n.</p>
          <% } %>

          <% const evaluacion = evaluaciones.find(ev =>
              ev.id_seccion === seccion.id_seccion &&
              ev.id_solicitud === solicitud.id_solicitud) || null; %>

          <% if (evaluacion) { 
const claseEstado =
  evaluacion.estado === 'Logrado'
    ? 'estado-logrado'
    : evaluacion.estado === 'No logrado'
    ? 'estado-no-logrado'
    : 'estado-en-proceso';
          %>
<div class="<%= claseEstado %>">
  <p><strong>Estado de evaluaci√≥n:</strong> <%= evaluacion.estado %></p>
  <% if (evaluacion.observaciones) { %>
    <p><strong>Observaciones:</strong> <%= evaluacion.observaciones %></p>
  <% } %>
</div>
<% } else { %>
  <p class="mensaje-evaluacion-pendiente">
    Esta secci√≥n a√∫n no ha sido evaluada.
  </p>
<% } %>
        </div>
      <% }) %>
    </main>
  </body>
</html>

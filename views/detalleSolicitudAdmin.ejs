<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Detalle de Solicitud</title>
    <link rel="stylesheet" href="/detalleSolicitudAdmin.css" />
  </head>
  <body>
    <header>
      <a class="back-btn" href="/admin/solicitudes">‚Üê Atr√°s</a>
      <h1>Detalle de Solicitud</h1>
      <div class="info-solicitud">
        <p><strong>Universidad:</strong> <%= solicitud.nombre_universidad %></p>
        <p><strong>Carrera:</strong> <%= solicitud.nombre_carrera %></p>
        <p>
          <strong>Fecha de Creaci√≥n:</strong>
          <%= new Date(solicitud.fecha_creacion).toLocaleDateString('es-PE', {
          day: '2-digit', month: '2-digit', year: 'numeric' }) %>
        </p>
      </div>
    </header>

    <main class="container">
      <% secciones.forEach(seccion => { %>
        <div class="seccion">
          <h2><%= seccion.nombre.replace(/\b\w/g, c => c.toUpperCase()) %></h2>

          <% const archivosSeccion = archivosPorSeccion.find(a =>
              a.seccion.id_seccion === seccion.id_seccion); %> 

          <% if (archivosSeccion && archivosSeccion.archivos.length > 0) { %>
            <ul class="lista-archivos">
              <% archivosSeccion.archivos.forEach(archivo => { %>
              <li>
                <span><%= archivo.nombre_archivo %> (<%= archivo.tipo_mime %>)</span>
                <a
                  href="/admin/descargar-archivo/<%= archivo.id_archivo %>"
                  class="btn-descargar"
                  download
                  >Descargar</a>
              </li>
              <% }) %>
            </ul>
          <% } else { %>
            <p class="sin-archivos">No hay archivos subidos en esta secci√≥n.</p>
          <% } %>

          <% const evaluacion = evaluaciones.find(ev =>
              ev.id_seccion === seccion.id_seccion &&
              ev.id_solicitud === solicitud.id_solicitud) || {}; %>

          <% if (solicitud.estado === 'en_evaluacion') { %>
<%
  const fechaHabilitacion = evaluacion.fecha_habilitacion ? new Date(evaluacion.fecha_habilitacion) : null;
  const ahora = new Date();
  const diasRestantes = fechaHabilitacion ? (7 - Math.floor((ahora - fechaHabilitacion) / (1000 * 60 * 60 * 24))) : 0;

  const seccionBloqueada =
    evaluacion.estado === 'En proceso' && fechaHabilitacion && diasRestantes > 0;

  const deshabilitado = evaluacion.estado === 'Logrado' || evaluacion.estado === 'No logrado' || seccionBloqueada;
%>
<% const claseEstado =
  evaluacion.estado === 'Logrado'
    ? 'evaluacion-logrado'
    : evaluacion.estado === 'No logrado'
    ? 'evaluacion-no-logrado'
    : '' %>

<% if (seccionBloqueada) { %>
  <div class="alerta-bloqueada">
    ‚ö†Ô∏è Esta secci√≥n fue marcada como "En proceso". El usuario puede subir nueva evidencia hasta el 
    <strong><%= new Date(fechaHabilitacion.getTime() + 7 * 24 * 60 * 60 * 1000).toLocaleDateString('es-PE') %></strong>. 
    No se puede evaluar hasta entonces.
  </div>
<% } %>
<form 
  method="POST" 
  action="/admin/evaluar/<%= solicitud.id_solicitud %>/<%= seccion.id_seccion %>" 
  class="form-evaluacion <%= claseEstado %>"
>
  <label for="estado-<%= seccion.id_seccion %>"><strong>Evaluaci√≥n:</strong></label>
  <select name="estado" id="estado-<%= seccion.id_seccion %>" required <%= deshabilitado ? "disabled" : "" %>>
    <option value="">Seleccione evaluaci√≥n</option>
    <option value="Logrado" <%= evaluacion.estado === 'Logrado' ? 'selected' : '' %>>Logrado</option>
    <option value="En proceso" <%= evaluacion.estado === 'En proceso' ? 'selected' : '' %>>En proceso</option>
    <option value="No logrado" <%= evaluacion.estado === 'No logrado' ? 'selected' : '' %>>No logrado</option>
  </select>

  <label for="observaciones-<%= seccion.id_seccion %>">Observaciones:</label>
  <textarea
    id="observaciones-<%= seccion.id_seccion %>"
    name="observaciones"
    rows="2"
    placeholder="Comentarios del evaluador..."
    <%= deshabilitado ? "disabled" : "" %>
  ><%= evaluacion.observaciones || '' %></textarea>

  <% if (!deshabilitado) { %>
    <button type="submit" class="btn-guardar">Guardar Evaluaci√≥n</button>
  <% } %>
</form>

          <% } else { %>
            <p class="mensaje-evaluacion-pendiente">
              üïí Esta solicitud a√∫n est√° en proceso. La evaluaci√≥n estar√° disponible despu√©s de los 30 d√≠as.
            </p>
          <% } %>
        </div>
      <% }) %>
    </main>

    <script>
  // Esperar a que el DOM est√© listo
  document.addEventListener("DOMContentLoaded", function () {
    const formularios = document.querySelectorAll(".form-evaluacion");

    formularios.forEach(form => {
      form.addEventListener("submit", function (e) {
        const btn = form.querySelector("button[type='submit']");
        btn.disabled = true;
        btn.textContent = "Guardando...";

        // Mostrar el alert luego de un peque√±o delay para que la redirecci√≥n no lo cancele
        setTimeout(() => {
          alert("‚úÖ Evaluaci√≥n guardada correctamente");
        }, 100);
      });
    });
  });
</script>

  </body>
</html>
